# Cleaning datasets and merging them into one, so that country-level comparison and analysis is possible

#Library
library(readxl)
library(tidyverse)
library(shinyBS)
library(shinyWidgets)
library(rintrojs)
library(latex2exp)
library(scales)
library(ggplot2)
library(gridExtra)
library(here)
library(openxlsx)
library(writexl)
library(gridExtra)
library(grid)
library(cowplot)
library(ggbreak)
library(ggprism)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(sf)
library(geojsonsf)

here()



# Aboveground and Belowground Biomass Carbon Density for the year 2010

Aboveground_and_Belowground_Biomass_Carbon_Density_Zonal_Statistics <- read_csv(here("data/input/Aboveground_and_Belowground_Biomass_Carbon_Density_Zonal_Statistics.csv")) %>% 
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    Biomass_Carbon_Density = sum(`sum`, na.rm = TRUE) / country_area,
    Biomass_Carbon = sum(`sum`, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(Biomass_Carbon_Density, country_area, Biomass_Carbon),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    unit = case_when(
      Variable == "Biomass_Carbon_Density" ~ "Mg/ha",
      Variable == "country_area" ~ "ha",
      Variable == "Biomass_Carbon" ~ "Mg"
    ),
    source = "Aboveground_and_Belowground_Biomass_Carbon_Density",
    description = case_when(
      Variable == "Biomass_Carbon_Density" ~ "Aboveground and Belowground Biomass Carbon Density",
      Variable == "Biomass_Carbon" ~ "Aboveground and Belowground Total Biomass Carbon",
      Variable == "country_area" ~ "Area of the country"
    )
  ) %>%
  select(iso3, Variable, Value, unit, description, source)


# Global tree cover (existing and potential)
Bastin_Zonal_Statistics <- read_csv(here("data/input/Bastin_Zonal_Statistics.csv")) %>% 
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    Tree_cover = sum(`mean` * area, na.rm = TRUE) / sum(area, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(Tree_cover, country_area),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    unit = case_when(
      Variable == "Tree_cover" ~ "%",
      Variable == "country_area" ~ "ha"
    ),
    source = "Bastinetal_2019",
    description = case_when(
      Variable == "Tree_cover" ~ "Global tree cover (existing and potential)",
      Variable == "country_area" ~ "Area of the country"
    )
  ) %>%
  select(iso3, Variable, Value, unit, description, source)



# Aboveground_and_Belowground_Biomass_Carbon_Density_Zonal_Statistics and Bastin_Zonal_Statistics have the same structure 
# => possible graph indicating corremation between tree coverage and carbon density




# Indian restoration areas

Chaturvedi_ZonalStatistics <- read_csv(here("data/input/Chaturvedi _ZonalStatistics.csv")) %>% 
  mutate(
    iso3 = "IND",
    source = "Chaturvedietal_2018"
  ) %>% 
  rename(
    "Excluded_areas" = "0",
    "Protection" = "1",
    "Wide_scale_Restoration" = "2",
    "Mosaic_Restoration" = "3"
  ) %>% 
  summarise(
    Excluded_areas = sum(Excluded_areas, na.rm = TRUE),
    Protection = sum(Protection, na.rm = TRUE),
    Wide_scale_Restoration = sum(Wide_scale_Restoration, na.rm = TRUE),
    Mosaic_Restoration = sum(Mosaic_Restoration, na.rm = TRUE)
  ) %>% 
  mutate(
    iso3 = "IND",
    unit = "ha",
    source = "Chaturvedietal_2018"
  ) %>%
  pivot_longer(
    cols = c(Excluded_areas, Protection, Wide_scale_Restoration, Mosaic_Restoration),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    description = case_when(
      Variable == "Excluded_areas" ~ "Excluded areas",
      Variable == "Protection" ~ "Protection",
      Variable == "Wide_scale_Restoration" ~ "Wide-scale Restoration",
      Variable == "Mosaic_Restoration" ~ "Mosaic Restoration"
    )
  ) %>%
  select(iso3, Variable, Value, unit, description, source)



# Carbon sequestration potential from reforestation in CO2e

Griscom_Zonal_Statistics <- read_csv(here("data/input/Griscom_Zonal_Statistics.csv")) %>% 
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    Reforestation_carbonseq_total = sum(`sum`, na.rm = TRUE),
    Reforestation_carbonseq_density = sum(`sum`, na.rm = TRUE) / country_area
  ) %>%    
  pivot_longer(
    cols = c(Reforestation_carbonseq_density, Reforestation_carbonseq_total, country_area),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    unit = case_when(
      Variable == "Reforestation_carbonseq_density" ~ "kgCO2e ha-1 yr-1",
      Variable == "Reforestation_carbonseq_total" ~ "kgCO2e yr-1",
      Variable == "country_area" ~ "ha"
    ),
    description = case_when(
      Variable == "Reforestation_carbonseq_density" ~ "Density of carbon sequestration potential from reforestation",
      Variable == "Reforestation_carbonseq_total" ~ "Total carbon sequestration potential from reforestation",
      Variable == "country_area" ~ "Area of the country"
    ),
    source = "Griscometal_2017"
  ) %>%
  select(iso3, Variable, Value, unit, description, source)





# Net Climate Impact of tree cover restoration (carbon storage and albedo change)

Hasler_Zonal_Statistics <- read_csv(here("data/input/Hasler_Zonal_Statistics.csv")) %>%
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    ClimateImpact_treecoverrestoration_total = sum(`sum`, na.rm = TRUE),
    ClimateImpact_treecoverrestoration_density = sum(`sum`, na.rm = TRUE) / country_area
  ) %>%
  pivot_longer(
    cols = c(ClimateImpact_treecoverrestoration_total, ClimateImpact_treecoverrestoration_density, country_area),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    unit = case_when(
      Variable == "ClimateImpact_treecoverrestoration_total" ~ "Mg CO2e",
      Variable == "ClimateImpact_treecoverrestoration_density" ~ "Mg CO2e ha-1",
      Variable == "country_area" ~ "ha"
    ),
    description = case_when(
      Variable == "ClimateImpact_treecoverrestoration_total" ~ "Net Climate Impact of tree cover restoration (carbon storage and albedo change)",
      Variable == "ClimateImpact_treecoverrestoration_density" ~ "Density of Net Climate Impact of tree cover restoration (carbon storage and albedo change) per hectare",
      Variable == "country_area" ~ "Area of the country"
    ),
    source = "Hasleretal_2024"
  ) %>%
  select(iso3, Variable, Value, unit, source, description)




# Constrained unrealized potential aboveground biomass, belowground biomass, and soil organic carbon combined density under baseline climate

Walker_Zonal_Statistics <- read_csv(here("data/input/Walker_Zonal_Statistics.csv")) %>% 
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    Potential_carbonland_total = sum(`sum`, na.rm = TRUE),
    Potential_carbonland_density = sum(`sum`, na.rm = TRUE) / country_area
  ) %>%
  pivot_longer(
    cols = c(Potential_carbonland_total, Potential_carbonland_density, country_area),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    unit = case_when(
      Variable == "Potential_carbonland_total" ~ "Mg C",
      Variable == "Potential_carbonland_density" ~ "Mg C ha-1",
      Variable == "country_area" ~ "ha"
    ),
    description = case_when(
      Variable == "Potential_carbonland_total" ~ "Total constrained unrealized potential aboveground biomass, belowground biomass, and soil organic carbon under baseline climate",
      Variable == "Potential_carbonland_density" ~ "Density of constrained unrealized potential aboveground biomass, belowground biomass, and soil organic carbon under baseline climate",
      Variable == "country_area" ~ "Area of the country"
    ),
    source = "Walkeral_2022"
  ) %>%
  select(iso3, Variable, Value, unit, description, source)




# Potential for forest regeneration in tropical regions

Williams_Zonal_Statistics <- read_csv(here("data/input/Williams_Zonal_Statistics.csv")) %>% 
  group_by(iso3) %>%
  summarise(
    country_area = sum(area, na.rm = TRUE),
    Potential_forestregeneration_total = sum(`sum`, na.rm = TRUE),
    Potential_forestregeneration_percent = 100 * sum(`sum`, na.rm = TRUE) / country_area
  ) %>%
  pivot_longer(
    cols = c(Potential_forestregeneration_total, Potential_forestregeneration_percent, country_area),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Value = ifelse(Variable == "Potential_forestregeneration_percent",
                   round(Value, 2),
                   Value),
    unit = case_when(
      Variable == "Potential_forestregeneration_total" ~ "ha",
      Variable == "Potential_forestregeneration_percent" ~ "%",
      Variable == "country_area" ~ "ha"
    ),
    description = case_when(
      Variable == "Potential_forestregeneration_total" ~ "Total potential for forest regeneration in tropical regions",
      Variable == "Potential_forestregeneration_percent" ~ "Share of country area with potential for forest regeneration (%)",
      Variable == "country_area" ~ "Area of the country"
    ),
    source = "Williamsal_2024"
  ) %>%
  select(iso3, Variable, Value, unit, description, source)

# Data are correct => compared with the paper results



restoration_db <- Aboveground_and_Belowground_Biomass_Carbon_Density_Zonal_Statistics %>% 
  rbind(Bastin_Zonal_Statistics) %>% 
  rbind(Chaturvedi_ZonalStatistics) %>% 
  rbind(Griscom_Zonal_Statistics) %>% 
  rbind(Hasler_Zonal_Statistics) %>% 
  rbind(Walker_Zonal_Statistics) %>% 
  rbind(Williams_Zonal_Statistics) %>% 
  distinct(iso3, Variable, .keep_all = TRUE) %>% 
  drop_na()




### FIGURES AND ANALYSIS ###

# Tree cover
treecover_top6 <- restoration_db %>%
  filter(Variable == "Tree_cover") %>%
  arrange(desc(Value)) %>%
  slice_head(n = 6)


labels_map <- c(
  "VCT" = "Saint Vincent & Grenadines",
  "MYS" = "Malaysia",
  "SLB" = "Solomon Islands",
  "GUY" = "Guyana",
  "SUR" = "Suriname",
  "GUF" = "French Guiana"
)

# Plot with custom labels
treecover_plot <- ggplot(treecover_top6, aes(x = reorder(iso3, -Value), y = Value, fill = iso3)) +
  geom_col(show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "",
    y = "Tree cover (%)",
    title = "Top 6 Countries with Highest Tree Cover"
  ) +
  scale_x_discrete(labels = labels_map)




# Biomass_Carbon => aaboveandbelowground => carbon potential in 2010
biomass_top6 <- restoration_db %>%
  filter(Variable == "Biomass_Carbon") %>%
  arrange(desc(Value)) %>%
  slice_head(n = 6)

# Labels for biomass plot
labels_map_biomass <- c(
  "IDN" = "Indonesia",
  "COD" = "DR Congo",
  "CAN" = "Canada",
  "USA" = "United States",
  "RUS" = "Russia",
  "BRA" = "Brazil"
)

# Plot
biomass_plot <- ggplot(biomass_top6, aes(x = reorder(iso3, -Value), y = Value / 1e9, fill = iso3)) +
  geom_col(show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "",
    y = "Biomass Carbon (Pg C)", 
    title = "Top 6 Countries with Highest Biomass Carbon"
  ) +
  scale_x_discrete(labels = labels_map_biomass)





# Biomass_Carbon => WALKER unrealized potential => potential - current
unrealizedcarbon_top6 <- restoration_db %>%
  filter(Variable == "Potential_carbonland_total") %>%
  arrange(desc(Value)) %>%
  slice_head(n = 6)


labels_map <- c(
  "IDN" = "Indonesia",
  "COD" = "DR Congo",
  "CHN" = "China",
  "USA" = "United States",
  "RUS" = "Russia",
  "BRA" = "Brazil"
)

# Plot
unrealizedcarbon_plot <- ggplot(unrealizedcarbon_top6, aes(x = reorder(iso3, -Value), y = Value / 1e9, fill = iso3)) +
  geom_col(show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "",
    y = "Biomass and Soil Organic Carbon (Pg C)", 
    title = "Top 6 Countries with Highest Unrealized potential biomass and carbon"
  ) +
  scale_x_discrete(labels = labels_map)






restoration_wide <- restoration_db %>%
  filter(Variable %in% c("Biomass_Carbon_Density", "country_area")) %>%
  select(iso3, Variable, Value) %>%  # drop source/unit to avoid duplicates
  pivot_wider(names_from = Variable, values_from = Value)

mean_density <- restoration_wide %>%
  summarise(weighted_mean = weighted.mean(Biomass_Carbon_Density, country_area, na.rm = TRUE)) %>%
  pull(weighted_mean)

biomass_density_top6 <- restoration_wide %>%
  arrange(desc(Biomass_Carbon_Density)) %>%
  slice_head(n = 6)

biomass_density_plot <- ggplot(biomass_density_top6, 
                               aes(x = reorder(iso3, Biomass_Carbon_Density), 
                                   y = Biomass_Carbon_Density, fill = iso3)) +
  geom_col(show.legend = FALSE) +
  geom_hline(yintercept = mean_density, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(
    x = "",
    y = "Biomass Carbon Density (Mg/ha)",
    title = "Top 6 Countries with Highest Biomass Carbon Density",
    subtitle = paste0("Global weighted mean = ", round(mean_density, 2), " Mg/ha")
  )





### IDEA OF ANALYSIS ###
  
# Aboveground and Belowground Biomass Carbon Density
# Global tree cover (existing and potential)
# Indian restoration areas
# Carbon sequestration potential from reforestation in CO2e
# Net Climate Impact of tree cover restoration (carbon storage and albedo change)
# Constrained unrealized potential aboveground biomass, belowground biomass, and soil organic carbon combined density under baseline climate
# Potential for forest regeneration in tropical regions






# Aboveground and Belowground Biomass Carbon Density => Biomass_Carbon
# Constrained unrealized potential aboveground biomass, belowground biomass, and soil organic carbon combined density under baseline climate => Potential_carbonland_total

biomass_db <- restoration_db %>% 
  filter(Variable %in% c("Biomass_Carbon", "Potential_carbonland_total")) %>%
  filter(iso3 %in% c("BRA", "RUS", "USA", "CAN", "COD", "IDN", "CHN")) %>% 
  select(iso3, Variable, Value) %>% 
  pivot_wider(names_from = Variable, values_from = Value) %>% 

  select(iso3, Biomass_Carbon, Potential_carbonland_total) %>% 
  pivot_longer(
    cols = c(Biomass_Carbon, Potential_carbonland_total),
    names_to = "Type",
    values_to = "Value"
  )

labels_map <- c(
  "IDN" = "Indonesia",
  "COD" = "DR Congo",
  "CHN" = "China",
  "USA" = "United States",
  "RUS" = "Russia",
  "BRA" = "Brazil",
  "CAN" = "Canada"
)

labels_map_type <- c(
  "Biomass_Carbon" = "Current Carbon Stock (above and below biomass)",
  "Potential_carbonland_total" = "Unrealized Potential Carbon Stock (above and below biomass + SOC)"
)

biomass_plot <- ggplot(biomass_db, aes(x = iso3, y = Value / 1e9, fill = Type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "",
    y = "Carbon Stock (Pg C)",
    fill = "",
    title = "Current vs Unrealized Potential Carbon Stock by Country"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = labels_map) +
  scale_fill_manual(values = c("Biomass_Carbon" = "#1f77b4", 
                               "Potential_carbonland_total" = "#ff7f0e"),
                    labels = labels_map_type)




# biomassdensity_db <- restoration_db %>% 
#   filter(Variable %in% c("Biomass_Carbon_Density", "Potential_carbonland_density")) %>%
#   filter(iso3 %in% c("BRA", "RUS", "USA", "CAN", "COD", "IDN", "CHN", "AUS")) %>% 
#   select(iso3, Variable, Value) %>% 
#   pivot_wider(names_from = Variable, values_from = Value) %>% 
#   
#   select(iso3, Biomass_Carbon_Density, Potential_carbonland_density) %>% 
#   pivot_longer(
#     cols = c(Biomass_Carbon_Density, Potential_carbonland_density),
#     names_to = "Type",
#     values_to = "Value"
#   )


# biomassdensity_plot <- ggplot(biomassdensity_db, aes(x = iso3, y = Value, fill = Type)) +
#   geom_col(position = "dodge") +
#   scale_y_continuous(labels = scales::comma) +
#   labs(
#     x = "Country",
#     y = "Carbon Stock by hectare  (Mg C/ha) ",
#     fill = "Type",
#     title = "Current vs Potential Carbon Stock by Country"
#   ) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))




